# 追讨宝物 - 完整需求分析文档

## 1. 项目概述

### 1.1 游戏类型
模拟经营类网页游戏，手机版Web页面，使用JavaScript开发，单HTML文件完成。

### 1.2 游戏背景
玩家缴纳费用找NPC追讨宝物，NPC给玩家2个选项：**收下葫芦**、**收下珍珠**。

### 1.3 货币系统
- 货币单位：**文**（如：1文钱、100文钱）
- 玩家初始金钱：**20亿文**（2,000,000,000文）
- 金钱上不封顶

---

## 2. 核心玩法

### 2.1 追讨任务类型

| 任务类型 | 固定花费 |
|---------|---------|
| 普通追讨 | 200万文 |
| 高级追讨 | 1000万文 |
| 超级追讨 | 1亿文 |

### 2.2 任务星级

玩家每次花费固定费用后，从4个随机任务中认领1个。

**普通/高级追讨星级概率：**

| 星级 | 概率 |
|------|------|
| 二星追讨任务 | 65% |
| 三星追讨任务 | 20% |
| 四星追讨任务 | 10% |
| 五星追讨任务 | 5% |

**超级追讨星级概率：**

| 星级 | 概率 |
|------|------|
| 二星追讨任务 | 65% |
| 三星追讨任务 | 20% |
| 四星追讨任务 | 12% |
| 五星追讨任务 | 3% |

### 2.3 NPC系统

每个任务由1个NPC发放，NPC之间等价（仅展示效果不同，不影响奖励）。

**NPC名单（常量数组配置）：**
```javascript
const NPC_LIST = [
    "段铁心",
    "商会会长",
    "天机老人",
    "云中子",
    "紫霞仙子",
    "铁扇公主",
    "镇元大仙",
    "太白金星",
    "南极仙翁",
    "东海龙王"
];

const NPC_AVATARS = ["👤", "🧔", "👴", "🧙", "👸", "👩", "🧓", "👨", "🎅", "🐉"];
```

### 2.4 奖励选择机制

玩家获得任务后，需要在两个选项中二选一：

| 选项 | 机制 |
|------|------|
| **收下珍珠** | 100%获得奖励（基础值±30%随机浮动） |
| **收下葫芦** | 50%概率获得珍珠的2倍奖励（±30%浮动），50%概率什么都没有 |

**特殊情况：** 超级追讨五星的葫芦奖励（紫帝晶）基础值为20亿文（±30%浮动）。

**数学期望对比：**
- 珍珠期望值 = 基础奖励值 × 100% = 基础奖励值
- 葫芦期望值 = 基础奖励值 × 2 × 50% = 基础奖励值 × 100%

> 珍珠与葫芦期望相同，但葫芦风险更大。

---

## 3. 宝物与奖励系统

### 3.1 宝物类型

| 星级 | 宝物名称 |
|------|---------|
| 二星 | 珍珠 |
| 三星 | 玉盘 |
| 四星 | 金樽 |
| 五星 | 紫晶（超级五星为"紫帝晶"）|

### 3.2 宝物命名规则

格式：`{星级}{追讨类型}{宝物名}`

示例：
- 二星普通珍珠、二星高级珍珠、二星超级珍珠
- 三星普通玉盘、三星高级玉盘、三星超级玉盘
- 四星普通金樽、四星高级金樽、四星超级金樽
- 五星普通紫晶、五星高级紫晶、五星超级**紫帝晶**

### 3.3 奖励价值配置

**全局目标返奖率：95%**

**奖励规则：**
- 珍珠奖励：基础值 ±30% 随机浮动
- 葫芦奖励：珍珠基础值的2倍 ±30% 随机浮动（50%概率获得）
- 特殊：超级五星紫帝晶葫芦奖励基础值20亿（±30%浮动）

#### 3.3.1 普通追讨（花费200万文）

| 星级 | 概率 | 珍珠基础奖励 | 葫芦基础奖励 |
|------|------|-------------|-------------|
| 二星 | 65% | 20万文 | 40万文 |
| 三星 | 20% | 200万文 | 400万文 |
| 四星 | 10% | 400万文 | 800万文 |
| 五星 | 5% | 1940万文 | 3880万文 |

**珍珠策略返奖率验证：**
0.65×20 + 0.20×200 + 0.10×400 + 0.05×1940 = 13+40+40+97 = **190万** → 190/200 = **95%** ✓

#### 3.3.2 高级追讨（花费1000万文）

| 星级 | 概率 | 珍珠基础奖励 | 葫芦基础奖励 |
|------|------|-------------|-------------|
| 二星 | 65% | 100万文 | 200万文 |
| 三星 | 20% | 1000万文 | 2000万文 |
| 四星 | 10% | 2000万文 | 4000万文 |
| 五星 | 5% | 9700万文 | 1.94亿文 |

**珍珠策略返奖率验证：**
0.65×100 + 0.20×1000 + 0.10×2000 + 0.05×9700 = 65+200+200+485 = **950万** → 950/1000 = **95%** ✓

#### 3.3.3 超级追讨（花费1亿文）

| 星级 | 概率 | 珍珠基础奖励 | 葫芦基础奖励 |
|------|------|-------------|-------------|
| 二星 | 65% | 1000万文 | 2000万文 |
| 三星 | 20% | 1亿文 | 2亿文 |
| 四星 | 12% | 2亿文 | 4亿文 |
| 五星 | 3% | 9.7亿文 | **20亿文（紫帝晶）** |

**珍珠策略返奖率验证：**
0.65×1000 + 0.20×10000 + 0.12×20000 + 0.03×97000 = 650+2000+2400+2910 = **7960万** → 7960/10000 = **79.6%**

> 注：超级追讨因紫帝晶的存在，珍珠策略返奖率较低（79.6%），但葫芦策略期望更高。玩家需要在稳定与博弈之间抉择。

### 3.4 奖励浮动机制

所有奖励都在基础值的 ±30% 范围内随机浮动：

```javascript
function randomFloatReward(baseValue) {
    const fluctuation = 0.3;
    const multiplier = 1 - fluctuation + Math.random() * fluctuation * 2;
    return Math.floor(baseValue * multiplier);
}
```

实际奖励范围 = 基础值 × [0.7, 1.3]

---

## 4. 游戏模式

### 4.1 模式类型

| 模式 | 说明 | 倍率 |
|------|------|------|
| 光宇真实倍率 | 默认模式，使用标准概率和奖励 | 1倍 |
| GM模式 | 概率和奖励翻倍，用于测试 | 2倍 |

### 4.2 GM模式效果

1. **星级概率调整**：3星、4星、5星的出现概率乘以2（然后归一化）
2. **奖励翻倍**：所有珍珠和葫芦奖励的基础值乘以2
3. **葫芦中奖率翻倍**：50% × 2 = 100%（GM模式下葫芦必中）

```javascript
function getMultiplier() {
    return gameMode === 'gm' ? 2 : 1;
}
```

---

## 5. 数据持久化

### 5.1 存储内容

使用浏览器 `localStorage` 存储：

| 数据项 | 说明 |
|--------|------|
| 玩家金钱 | 当前余额 |
| 游玩记录 | 全部历史记录（不分页） |
| 总花费 | 累计花费金额 |
| 总收益 | 累计获得金额 |

### 5.2 存储键名

`zhuiTaoBaoWu_gameData`

### 5.3 重置功能

提供"重置游戏"按钮，点击后：
- 弹出确认对话框
- 清空所有 localStorage 数据
- 玩家金钱恢复为20亿文
- 游玩记录清空
- 游戏模式保持不变

---

## 6. UI/UX 设计

### 6.1 页面布局（桌面端左右分栏）

```
┌────────────────────────────────────────────────────────┐
│ 左侧面板                    │ 右侧面板                  │
│ ┌────────────────────────┐  │ ┌────────────────────┐   │
│ │ 选择追讨类型            │  │ │ 当前金钱: XXX文     │   │
│ │ [普通] [高级] [超级]    │  │ │ 总花费 | 总收益 | 盈亏│   │
│ └────────────────────────┘  │ └────────────────────┘   │
│ ┌────────────────────────┐  │ ┌────────────────────┐   │
│ │ 任务星级                │  │ │ 游玩记录            │   │
│ │ [二星][三星][四星][五星] │  │ │ - 第N次: ...        │   │
│ │ [ 开始追讨 ]            │  │ │ - ...               │   │
│ └────────────────────────┘  │ │ （可滚动）           │   │
│ ┌────────────────────────┐  │ └────────────────────┘   │
│ │ NPC对话区域（隐藏）      │  │ ┌────────────────────┐   │
│ │ [收下珍珠] [收下葫芦]    │  │ │ [ 重置游戏 ]        │   │
│ └────────────────────────┘  │ │ [光宇真实倍率][GM模式]│   │
│ ┌────────────────────────┐  │ └────────────────────┘   │
│ │ 结果展示区域（隐藏）     │  │                        │
│ │ [ 继续追讨 ]            │  │                        │
│ └────────────────────────┘  │                        │
└────────────────────────────────────────────────────────┘
```

### 6.2 移动端布局

移动端（宽度≤768px）自动切换为单列布局：
- 左侧面板在上
- 右侧面板在下
- 游玩记录最大高度限制为250px

### 6.3 滚动动画

**任务选择滚动效果：**
- 总时长：1.7秒（动画）+ 0.3秒（结果展示延迟）= 2秒
- 动画特效：缓动减速（easeOutCubic）
- 效果：高亮框在二星→三星→四星→五星之间循环滚动
- 速度变化：开始快，越滚越慢，最终停在结果上
- 最少循环：3圈后停止

**实现方式：**
```javascript
function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
}
```

### 6.4 游玩记录展示

每条记录包含：
- 序号
- 追讨类型（普通/高级/超级）
- 任务星级
- 发放NPC
- 选择（珍珠/葫芦）
- 花费金额
- 获得金额（0表示葫芦落空）

记录按时间倒序排列（最新在前）。

### 6.5 弹窗系统

使用自定义样式弹窗，不使用原生 `alert()`：

1. **重置确认弹窗**：确认/取消按钮
2. **金额不足弹窗**：显示"金额不足！请远离赌博！不赌为赢！"，右上角X关闭

---

## 7. 常量配置汇总

```javascript
// ==================== 游戏常量配置 ====================

// NPC列表
const NPC_LIST = [
    "段铁心", "商会会长", "天机老人", "云中子", "紫霞仙子",
    "铁扇公主", "镇元大仙", "太白金星", "南极仙翁", "东海龙王"
];

// NPC头像
const NPC_AVATARS = ["👤", "🧔", "👴", "🧙", "👸", "👩", "🧓", "👨", "🎅", "🐉"];

// 初始金钱（文）
const INITIAL_MONEY = 2000000000; // 20亿

// 追讨类型配置
const TASK_TYPES = {
    normal: { name: "普通", cost: 2000000 },      // 200万
    advanced: { name: "高级", cost: 10000000 },   // 1000万
    super: { name: "超级", cost: 100000000 }      // 1亿
};

// 星级概率配置（普通/高级追讨）
const STAR_PROBABILITY_NORMAL = {
    2: 0.65,  // 二星 65%
    3: 0.20,  // 三星 20%
    4: 0.10,  // 四星 10%
    5: 0.05   // 五星 5%
};

// 星级概率配置（超级追讨）
const STAR_PROBABILITY_SUPER = {
    2: 0.65,  // 二星 65%
    3: 0.20,  // 三星 20%
    4: 0.12,  // 四星 12%
    5: 0.03   // 五星 3%
};

// 星级名称
const STAR_NAMES = {
    2: "二星",
    3: "三星",
    4: "四星",
    5: "五星"
};

// 宝物名称配置
const TREASURE_NAMES = {
    2: "珍珠",
    3: "玉盘",
    4: "金樽",
    5: "紫晶"  // 超级五星为"紫帝晶"
};

// 葫芦机制配置
const GOURD_CONFIG = {
    winRate: 0.50,      // 葫芦获奖概率 50%
    multiplier: 2       // 葫芦奖励倍率（珍珠的2倍）
};

// 珍珠奖励配置（基础值，实际±30%浮动）
const PEARL_REWARDS = {
    normal: {   // 普通追讨（花费200万）
        2: 200000,      // 20万
        3: 2000000,     // 200万
        4: 4000000,     // 400万
        5: 19400000     // 1940万
    },
    advanced: { // 高级追讨（花费1000万）
        2: 1000000,     // 100万
        3: 10000000,    // 1000万
        4: 20000000,    // 2000万
        5: 97000000     // 9700万
    },
    super: {    // 超级追讨（花费1亿）
        2: 10000000,    // 1000万
        3: 100000000,   // 1亿
        4: 200000000,   // 2亿
        5: 970000000    // 9.7亿
    }
};

// 紫帝晶特殊配置（超级追讨五星葫芦奖励）
const PURPLE_EMPEROR_CRYSTAL = 2000000000; // 20亿（基础值）

// 动画配置
const ANIMATION_CONFIG = {
    duration: 1700     // 滚动动画时长 1.7秒
};

// 全局返奖率（用于验证，实际由奖励配置决定）
const TARGET_RETURN_RATE = 0.95; // 95%
```

---

## 8. 技术实现要点

### 8.1 文件结构
单HTML文件（`wendaolaotou.html`），包含：
- HTML结构
- CSS样式（`<style>`标签，每个class样式压缩为一行）
- JavaScript逻辑（`<script>`标签）

### 8.2 响应式设计
- 适配手机和桌面屏幕
- 使用 viewport meta 标签
- 弹性布局（Flexbox）
- 媒体查询断点：768px

### 8.3 数据存储
```javascript
// 存储
localStorage.setItem('zhuiTaoBaoWu_gameData', JSON.stringify(data));

// 读取
const data = JSON.parse(localStorage.getItem('zhuiTaoBaoWu_gameData'));

// 清空
localStorage.removeItem('zhuiTaoBaoWu_gameData');
```

### 8.4 游戏状态管理

```javascript
let gameMode = 'normal'; // 'normal' 或 'gm'

let gameState = {
    money: INITIAL_MONEY,           // 当前金钱
    totalSpent: 0,                  // 总花费
    totalEarned: 0,                 // 总收益
    history: [],                    // 游玩记录
    currentTaskType: 'normal',      // 当前选择的任务类型
    playingTaskType: null,          // 正在进行的任务类型（防止中途切换）
    currentStar: null,              // 当前任务星级
    currentNpcIndex: null,          // 当前NPC索引
    isAnimating: false              // 是否正在播放动画
};
```

### 8.5 核心逻辑函数

```javascript
// 获取当前模式倍率
function getMultiplier() {
    return gameMode === 'gm' ? 2 : 1;
}

// 根据概率选择星级（GM模式下3/4/5星概率翻倍并归一化）
function getRandomStar(taskType) {
    const baseProbConfig = taskType === 'super'
        ? STAR_PROBABILITY_SUPER
        : STAR_PROBABILITY_NORMAL;
    const mult = getMultiplier();

    let prob2 = baseProbConfig[2];
    let prob3 = baseProbConfig[3] * mult;
    let prob4 = baseProbConfig[4] * mult;
    let prob5 = baseProbConfig[5] * mult;

    const total = prob2 + prob3 + prob4 + prob5;
    prob2 /= total; prob3 /= total; prob4 /= total; prob5 /= total;

    const rand = Math.random();
    if (rand < prob2) return 2;
    if (rand < prob2 + prob3) return 3;
    if (rand < prob2 + prob3 + prob4) return 4;
    return 5;
}

// 奖励浮动（±30%）
function randomFloatReward(baseValue) {
    const fluctuation = 0.3;
    const multiplier = 1 - fluctuation + Math.random() * fluctuation * 2;
    return Math.floor(baseValue * multiplier);
}

// 获取珍珠奖励（基础值×模式倍率，±30%浮动）
function getPearlReward(taskType, star) {
    return randomFloatReward(PEARL_REWARDS[taskType][star] * getMultiplier());
}

// 获取葫芦奖励（特殊处理紫帝晶）
function getGourdReward(taskType, star) {
    if (taskType === 'super' && star === 5) {
        return randomFloatReward(PURPLE_EMPEROR_CRYSTAL * getMultiplier());
    }
    const pearlValue = PEARL_REWARDS[taskType][star];
    return randomFloatReward(pearlValue * GOURD_CONFIG.multiplier * getMultiplier());
}

// 葫芦是否中奖（GM模式下中奖率翻倍，最高100%）
function isGourdWin() {
    const rate = Math.min(GOURD_CONFIG.winRate * getMultiplier(), 1);
    return Math.random() < rate;
}
```

---

## 9. 附录：返奖率模拟验证代码

```javascript
// 模拟游戏（可选择珍珠或葫芦策略）
function simulateGame(times = 1000, taskType = 'normal', strategy = 'pearl') {
    const cost = TASK_TYPES[taskType].cost;
    let totalSpent = 0;
    let totalEarned = 0;

    for (let i = 0; i < times; i++) {
        totalSpent += cost;

        // 随机星级
        const star = getRandomStar(taskType);

        if (strategy === 'pearl') {
            // 珍珠策略：100%获得奖励
            totalEarned += getPearlReward(taskType, star);
        } else {
            // 葫芦策略：50%概率获得2倍奖励
            if (isGourdWin()) {
                totalEarned += getGourdReward(taskType, star);
            }
            // 50%概率什么都没有
        }
    }

    const returnRate = (totalEarned / totalSpent * 100).toFixed(2);
    console.log(`模拟${times}次${taskType}追讨（${strategy}策略）:`);
    console.log(`总花费: ${totalSpent}文`);
    console.log(`总收益: ${totalEarned}文`);
    console.log(`返奖率: ${returnRate}%`);

    return parseFloat(returnRate);
}

// 运行模拟验证
console.log('=== 珍珠策略（稳定收益）===');
simulateGame(10000, 'normal', 'pearl');   // 期望约95%
simulateGame(10000, 'advanced', 'pearl'); // 期望约95%
simulateGame(10000, 'super', 'pearl');    // 期望约80%

console.log('\n=== 葫芦策略（高风险）===');
simulateGame(10000, 'normal', 'gourd');   // 期望约95%
simulateGame(10000, 'advanced', 'gourd'); // 期望约95%
simulateGame(10000, 'super', 'gourd');    // 期望约80%（含紫帝晶）
```

---

## 10. 版本记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02-11 | 初始需求分析文档 |
| v1.1 | 2026-02-11 | 返奖率调整为90%，更新奖励数值配置 |
| v2.0 | 2026-02-11 | 根据最终代码实现更新文档：<br>- 返奖率调整为95%<br>- 星级概率更新（普通/高级：65%/20%/10%/5%，超级：65%/20%/12%/3%）<br>- 葫芦机制简化为50%中奖率、2倍奖励<br>- 所有奖励增加±30%随机浮动<br>- 新增GM模式（概率和奖励翻倍）<br>- 动画时长调整为1.7秒<br>- UI改为左右分栏布局<br>- 弹窗改为自定义样式 |
